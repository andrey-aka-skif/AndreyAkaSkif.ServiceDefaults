# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Publish NuGet Package

on:
    push:
        tags: ['v*.*.*']
    workflow_dispatch:

jobs:
    ci:
        uses: ./.github/workflows/ci.yml

    publish:
        needs: ci
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: read
        strategy:
            matrix:
                project: [
                    'src/ServiceDefaults/ServiceDefaults.csproj',
                    'src/ServiceDefaults.OpenApi/ServiceDefaults.OpenApi.csproj',
                    'src/ServiceDefaults.Swagger/ServiceDefaults.Swagger.csproj',
                    'src/ServiceDefaults.Serilog/ServiceDefaults.Serilog.csproj',
                    'src/ServiceDefaults.PostgreSQL/ServiceDefaults.PostgreSQL.csproj',
                ]
        steps:
            - name: ğŸ›’ Checkout
              uses: actions/checkout@v4

            - name: âœ¨ Setup .NET
              uses: actions/setup-dotnet@v4

            - name: ğŸ’¾ Cache NuGet packages
              uses: actions/cache@v4
              with:
                path: ~/.nuget/packages
                key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
                restore-keys: ${{ runner.os }}-nuget-

            - name: ğŸšš Restore
              run: dotnet restore

            - name: ğŸ› ï¸ Build
              run: dotnet build --configuration Release --no-restore

            - name: ğŸ“¦ Pack ${{ matrix.project }}
              run: dotnet pack ${{ matrix.project }} --configuration Release --output ./nupkgs

            - name: ğŸš€ Publish ${{ matrix.project }} to GitHub Packages
              run: |
                  dotnet nuget push ./nupkgs/*.nupkg \
                    --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
                    --api-key ${{ secrets.GH_PACKAGES_TOKEN }} \
                    --skip-duplicate
